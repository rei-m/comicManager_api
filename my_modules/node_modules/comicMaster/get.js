/**************************************************************************************************
 * モジュール名　: コミックマスタ情報返却
 * 概要　　　　　: 指定されたキーワードでコミックマスタ情報を検索して返却する
 *************************************************************************************************/

var logger = require("cmn/logger"),
    cmnFunc = require("cmn/cmnFunc");

// メインロジック
function main(Comic) {
  return function(req, res, next) {

    // クエリをログ出力
    logger.info(req.getQuery());

    // パラメータ取得
    var params = cmnFunc.getQuery(req.getQuery()),
        key = cmnFunc.getFindKey(params.key);

    // キーワードが入力されている場合のみ検索を行う
    if(key !== ""){
      // DBからキーワードで検索を行う
      Comic.find({key: new RegExp(key)}, function(err, docs){
        // 取得結果をJSONに変換
        var json = {},
            aryDocs = [];
        json.results_count = docs.length;
        for(var i=0,len=docs.length;i<len;i++){
          aryDocs[i] = {
            title : docs[i].title,
            author : docs[i].author,
            publisher : docs[i].publisher
          };
        }
        json.results_masterInfo = aryDocs;
        // レスポンスにJSONをセット
        res.send(json);
      });
    }else{
      res.send(cmnFunc.makeErrorResponse());
    }
  };
}
module.exports = main;
